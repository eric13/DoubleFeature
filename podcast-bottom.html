<?php
	
	// Hide Errors!
	error_reporting(0);

	// Clean certain characters from the title
	function cleanTitle($s) {
		$s = strtolower($s);
		$s = str_replace(":", "", "$s");
		$s = str_replace("'", "", "$s");
		$s = str_replace("’", "", "$s");
		$s = str_replace(".", "", "$s");
		$s = str_replace(",", "", "$s");
		$s = str_replace("!", "", "$s");
		$s = str_replace("(", "", "$s");
		$s = str_replace(")", "", "$s");
		$s = str_replace("…", "", "$s");
		$s = str_replace(" ", "-", "$s");
		// Catch characters after encoding
		$s = urlencode($s);
		$s = str_replace("%26%238230%3B", "", "$s");
		$s = str_replace("%26%238216%3B", "", "$s");
		$s = str_replace("%26%238217%3B", "", "$s");
		$s = str_replace("%28", "", "$s");
		$s = str_replace("%29", "", "$s");
		return $s;
	}
	
	function amazonLinker($s) {
		$s = str_replace("-", "+", "$s");
		$a = "http://amazon.com/gp/search?index=dvd&tag=tbmchicago-20&keywords=$s";
		return $a;
	}
	
	function iTunesLinker($s) {
		$s = str_replace("-", "", "$s");
		$a = "http://itunes.com/movie/$s";
		return $a;
	}

	// Creates the movie object with IMDB info
	class Movie {
		public $gctitle;
		public $gcimdb;
		public $gcwiki;
		public $amzn;
		public $itns;
		public $writers;
		public $director;
		public $desc;
		public $release;
		public $short;
		public $cast;
		public $ft = "jpg";
		
		public function __construct($i) {

			// Figures out film titles based on episode title
			$f = the_title("", "", false);
			$f = explode(" + ", $f);
			$this->gctitle = $f[$i-1];

			// Wordpress stores information in variables labeled with a 1 or 2 instead of in an array.
			if ($i=="1") {
				$this->gcimdb = gc_return(imdb1);
				$this->gcwiki = gc_return(wiki1);
				$this->amzn = gc_return(amzn1);
				$this->itns = gc_return(itns1);
			} else {
				$this->gcimdb = gc_return(imdb2);
				$this->gcwiki = gc_return(wiki2);
				$this->amzn = gc_return(amzn2);
				$this->itns = gc_return(itns2);
			}

			// Query a third party IMDB API which retrieves a JSON
			if ($this->gcimdb) {
				$q = file_get_contents("http://www.omdbapi.com/?i=$this->gcimdb");
			} else {
				// Don't have an IMDB? Let's try looking it up by title
				$srchr = str_replace(" ", "%20", $this->gctitle);
				$srchr = str_replace("’", "", $srchr);
				$q = file_get_contents("http://www.omdbapi.com/?t=$srchr");
				// The search returns the json with brackets, even with only one result.  Remove the brackets.
			}
			$m = json_decode($q, true);
			
			// Prep other attributes
			$this->writers = $m['Writer'];
			$this->director = $m['Director'];
			$this->desc = $m['Plot'];
			$this->release = date("F j, Y", strtotime($m[Released]));
			$this->short = cleanTitle($this->gctitle);
			$this->cast = $m[Actors];
			$this->runtime = $m[Runtime];

			
			// Alright, if we didn't have the IMDB to begin with let's set it.
			if (!$this->gcimdb) { $this->gcimdb = $m['imdb_id']; }
			if (!$this->gcwiki) { $this->gcwiki = str_replace("-", "_", $this->short); }

			// Annoying exception if the jpg filetype just didn't cut it
			if ($this->short == "the-king-of-kong") { $this->ft = "png"; }
			
			// Make Amazon and iTunes links if they weren't provided
			if (!$this->amzn) { $this->amzn = amazonLinker($this->short); }
			if (!$this->itns) { $this->itns = iTunesLinker($this->short); }
			
			}
		
		// Generates Director tag links if they have more than 1 tagged
		public function dlnk() {
			$d = $this->director;
			$tags = get_tags(array('name__like' => "$d"));
			$slugs = $tags[0]->slug;
			$nums = $tags[0]->count;
			if ($nums>1) { return "<a href=\"/tag/$slugs\">$d</a>"; } else { return $d; }
		}
	}

	// Create two movie objects in an array
	$mov = array(new Movie(1), new Movie(2));

?>

<h3>Covers</h3>

Click on a cover to view/download high resolution version.<br /><br />

<?

// Do a loop for each movie
$i=0; while ($i < count($mov)){

	// Determine if it's the first or second box on the row
	if($i&1) { $whichbox = "b"; } else { $whichbox = "a";}
	
	// Create the moviebox
	echo "
		<div id='movie-box-" . $whichbox . "'>
	
			<a href='/images/covers/" . 
			$mov[$i]->short . "." . $mov[$i]->ft . "' rel='lightbox' title='" . 
			$mov[$i]->gctitle . "&lt;a href=&quot;/images/covers/" . 
			$mov[$i]->short . "." . $mov[$i]->ft . "&quot;&gt;Download Hi-Res&lt;/a&gt;'><img src='/images/covers/thumbnails/thumbnail-" . 
			$mov[$i]->short . "." . $mov[$i]->ft . "' class='lbc' /></a>
			
			<h3>" . $mov[$i]->gctitle . "</h3>
			
			<a href='" . $mov[$i]->itns . "' target='_blank'><img src='/images/itunes.gif' alt='iTunes' class='itns_btn' /></a>
			<a href='" . $mov[$i]->amzn . "'><img src='/images/amazon.gif' alt='Amazon' class='amazn_btn' /></a>
			
			<br />
			
			Released: " . $mov[$i]->release . "<br />";
			
			if ($mov[$i]->runtime != ""){echo "Runtime: ". $mov[$i]->runtime . " | "; }
			
			echo "
			<a href='http://imdb.com/title/" . $mov[$i]->gcimdb . "' rel='nofollow' target='_blank'>IMDB</a> | 
			<a href='http://wikipedia.org/wiki/" . $mov[$i]->gcwiki . "' rel='nofollow' target='_blank'>Wikipedia</a><br /><br />
		
			Director: " . $mov[$i]->dlnk() . "<br />
			Writer: " . $mov[$i]->writers . "<br />
			Starring: " . $mov[$i]->cast . "<br /><br />
			
		" . $mov[$i]->desc . "<br /><br />
	
		</div>";
		
		// Clear it if it's after the second
	if($i&1) { echo "<div style='clear: both;'>&nbsp;</div>"; }
	
	$i++;
}

?>
